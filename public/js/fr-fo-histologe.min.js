Node.prototype.addEventListeners=function(e,t){for(let r of e.split(" "))this.addEventListener(r,t)};const e=new FormData,t=document.querySelectorAll('form.needs-validation:not([name="bug-report"])'),r=window.localStorage,l=e=>!("signalement-step-1"===e.id&&null===e.querySelector('[type="radio"]:checked')||"signalement-step-1"===e.id&&e.querySelectorAll('[type="checkbox"]:checked').length!==e.querySelectorAll('[type="radio"]:checked').length),a=e=>{let t=e.querySelector('fieldset[aria-required="true"]');return!t||(null===t.querySelector('[type="checkbox"]:checked')?(t.classList.add("fr-fieldset--error"),t?.querySelector(".fr-error-text")?.classList.remove("fr-hidden"),invalid=t.parentElement,!1):(t.classList.remove("fr-fieldset--error"),t?.querySelector(".fr-error-text")?.classList.add("fr-hidden"),!0))},n=function(e){const t=e.split(","),r=t[0].match(/:(.*?);/)[1],l=atob(t[1]);let a=l.length;const n=new Uint8Array(a);for(;a--;)n[a]=l.charCodeAt(a);return new Blob([n],{type:r})};t.forEach((i=>{i?.querySelectorAll('.toggle-criticite input[type="radio"]')?.forEach((e=>{e.addEventListener("change",(e=>{e.currentTarget.parentElement.parentElement.parentElement.querySelector(".fr-toggle__input").checked=!0}))})),i?.querySelectorAll(".fr-toggle")?.forEach((e=>{e.addEventListener("change",(e=>{e.target.checked||e.currentTarget.nextElementSibling.querySelectorAll('.fr-collapse input[type="radio"]').forEach((e=>{e.checked=!1,e.required=!1}))}))})),i?.querySelectorAll(".fr-accordion__title")?.forEach((e=>{e.addEventListeners("click touchdown",(e=>{e.target.parentElement.parentElement.querySelectorAll('[type="radio"],[type="checkbox"]').forEach((e=>{e.checked=!1}))}))})),i?.querySelectorAll("[data-fr-toggle-show],[data-fr-toggle-hide]")?.forEach((e=>{e.addEventListener("change",(e=>{let t=e.target.getAttribute("data-fr-toggle-show"),r=e.target.getAttribute("data-fr-toggle-hide"),l=e.target.getAttribute("data-fr-toggle-unrequire"),a=e.target.getAttribute("data-fr-toggle-require");t&&t.split("|").map((e=>{let t;"signalement-consentement-tiers-bloc"===e?(t=document?.querySelector("#signalement-consentement-tiers-bloc"),t.querySelector('[type="checkbox"]').required=!0):(t=i?.querySelector("#"+e),t.querySelectorAll('input:not([type="checkbox"]),textarea,select').forEach((e=>{e.required=!0}))),"signalement-methode-contact"===t.id&&t.querySelector("fieldset").setAttribute("aria-required",!0),t.classList.remove("fr-hidden")})),r&&r.split("|").map((e=>{let t;"signalement-consentement-tiers-bloc"===e?(t=document.querySelector("#signalement-consentement-tiers-bloc"),t.querySelector('[type="checkbox"]').required=!1):(t=i?.querySelector("#"+e),t?.querySelectorAll('input:not([type="checkbox"]),textarea,select')?.forEach((e=>{e.required=!1}))),"signalement-methode-contact"===t.id&&(t?.querySelector('fieldset[aria-required="true"]')?.removeAttribute("aria-required"),t?.querySelectorAll('[type="checkbox"]')?.forEach((e=>{e.checked=!1}))),t.classList.add("fr-hidden")})),l&&l.split("|").map((e=>{let t=i?.querySelector("#"+e);t||(t=document?.querySelector("#"+e)),t.required=!1,t?.parentElement?.classList?.remove("fr-input-group--error"),t?.parentElement?.querySelector(".fr-error-text")?.classList.add("fr-hidden"),t?.classList?.remove("fr-input--error"),t.labels[0].classList.remove("required")})),a&&a.split("|").map((e=>{let t=i?.querySelector("#"+e);t||(t=document?.querySelector("#"+e)),t.required=!0,t?.labels[0]?.classList.add("required")}))}))})),i?.querySelectorAll('input[type="file"]')?.forEach((t=>{t.addEventListener("change",(t=>{if(t.target.files.length>0){let a=t.target.parentElement.parentElement.querySelector(".signalement-uploadedfile-delete"),i=t.target?.parentElement?.querySelector("img"),c=!1;if(i){const a=524288,o=a/t.target.files[0].size/2;t.target.files[0].size>a?(r=t.target.files[0],l=o,new Promise((function(e,t){const a=new FileReader;a.readAsDataURL(r),a.addEventListener("load",(function(t){const r=new Image;r.addEventListener("load",(function(){const t=document.createElement("canvas"),a=t.getContext("2d"),i=r.width*l,c=r.height*l;t.width=i,t.height=c,a.drawImage(r,0,0,i,c),"toBlob"in t?t.toBlob((function(t){e(t)})):e(n(t.toDataURL()))})),r.src=t.target.result})),a.addEventListener("error",(function(e){t()}))}))).then((function(r){i.src=URL.createObjectURL(r),e.append(t.target.name,r),t.target.value=""})):i.src=URL.createObjectURL(t.target.files[0]),["fr-fi-instagram-line","fr-py-7v"].map((e=>t.target.parentElement.classList.toggle(e))),c=!0}else t.target.parentElement.classList.contains("fr-fi-attachment-fill")&&(t.target.files[0].size>2097152?(t.target.value="",t.target.parentElement.parentElement.querySelector("small.fr-hidden").classList.remove("fr-hidden")):(c=!0,["fr-fi-attachment-fill","fr-fi-checkbox-circle-fill"].map((e=>t.target.parentElement.classList.toggle(e)))));c&&([i,a].forEach((e=>e?.classList?.remove("fr-hidden"))),a.addEventListeners("click touchdown",(r=>{r.preventDefault(),i?(i.src="#",t.target.parentElement.classList.add("fr-fi-instagram-line")):t.target.parentElement.classList.contains("fr-fi-checkbox-circle-fill")&&["fr-fi-attachment-fill","fr-fi-checkbox-circle-fill"].map((e=>t.target.parentElement.classList.toggle(e))),t.target.value="",e.delete(t.target.name),[i,a].forEach((e=>e?.classList.add("fr-hidden")))})))}var r,l}))})),i?.querySelectorAll("[data-fr-adresse-autocomplete]").forEach((e=>{e.addEventListener("keyup",(()=>{e.value.length>10&&fetch("https://api-adresse.data.gouv.fr/search/?q="+e.value).then((e=>{e.json().then((e=>{let t=i.querySelector("#signalement-adresse-suggestion");t.innerHTML="";for(let r of e.features){let e=document.createElement("div");e.classList.add("fr-col-12","fr-p-3v","fr-text-label--blue-france","fr-adresse-suggestion"),e.innerHTML=r.properties.label,e.addEventListener("click",(()=>{i.querySelector("#signalement_adresseOccupant").value=r.properties.name,i.querySelector("#signalement_cpOccupant").value=r.properties.postcode,i.querySelector("#signalement_villeOccupant").value=r.properties.city,i.querySelector("#signalement-insee-occupant").value=r.properties.citycode,i.querySelector("#signalement-geoloc-lat-occupant").value=r.geometry.coordinates[0],i.querySelector("#signalement-geoloc-lng-occupant").value=r.geometry.coordinates[1],t.innerHTML=""})),t.appendChild(e)}}))}))}))})),i.addEventListener("submit",(n=>{if(n.preventDefault(),i.checkValidity()&&l(i)&&a(i))if(i.querySelectorAll("input,textarea,select").forEach((e=>{let t=e.parentElement;"radio"===e.type&&(t=e.parentElement.parentElement.parentElement),[e.classList,t.classList].forEach((e=>{e.remove(e[0]+"--error")})),t.querySelector(".fr-error-text")?.classList.add("fr-hidden")})),"signalement"!==i.name)i.submit();else{let l=document.querySelector('.fr-tabs__list>li>button[aria-selected="true"]').parentElement?.nextElementSibling?.querySelector("button");if(l&&(l.hasAttribute("data-fr-last-step")&&(document.querySelector("#recap-signalement-situation").innerHTML="",t.forEach((e=>{e.querySelectorAll("input,textarea,select").forEach((e=>{document.querySelector("#recap-"+e.id)?document.querySelector("#recap-"+e.id).innerHTML=e.value:e.classList.contains("signalement-situation")&&e.checked&&(document.querySelector("#recap-signalement-situation").innerHTML+="- "+e.value+"<br>")}))}))),l.disabled=!1,l.click()),!l){n.submitter.disabled=!0,["fr-fi-checkbox-circle-fill","fr-fi-refresh-fill"].map((e=>n.submitter.classList.toggle(e))),n.submitter.innerHTML="En cours d'envoi...";let l=new FormData;t.forEach((t=>{let r=(e=>Array.from(new FormData(e).entries()).reduce((function(e,t){return e[t[0]]=t[1],e}),{}))(t);for(let t=0;t<Object.keys(r).length;t++){let a=Object.keys(r)[t],n=Object.values(r)[t];e.has(a)?(l.append(a,e.get(a)),e.delete(a)):l.append(a,n)}})),fetch(i.action,{method:"POST",body:l}).then((e=>{e.ok?e.json().then((e=>{"success"===e.response?(document.querySelectorAll("#signalement-tabs,#signalement-success").forEach((e=>{e.classList.toggle("fr-hidden")})),r.clear()):"success_edited"===e.response?window.location.reload():(n.submitter.disabled=!1,n.submitter.innerHTML="Confirmer",["fr-fi-checkbox-circle-fill","fr-fi-refresh-fill"].map((e=>n.submitter.classList.toggle(e))),alert("Erreur signalement !"))})):(n.submitter.disabled=!1,n.submitter.innerHTML="Confirmer",["fr-fi-checkbox-circle-fill","fr-fi-refresh-fill"].map((e=>n.submitter.classList.toggle(e))),alert("Erreur signalement !"))}))}}else if(n.stopPropagation(),"signalement-step-1"===i.id?(i.querySelector('[role="alert"]').classList.remove("fr-hidden"),i?.querySelectorAll(".fr-fieldset__content.fr-collapse.fr-collapse--expanded").forEach((e=>{e.querySelector('[type="radio"]:first-of-type').required=!0,e.querySelector("input:invalid")&&(e.classList.add("fr-fieldset--error"),e.querySelector(".fr-error-text").classList.remove("fr-hidden"))})),invalid=i?.querySelector("*:invalid:first-of-type")?.parentElement,invalid||(invalid=document.querySelector("div[role='alert']")),i.addEventListener("change",(()=>{i?.querySelectorAll(".fr-fieldset__content.fr-collapse.fr-collapse--expanded").forEach((e=>{null===e.querySelector("input:invalid")&&(e.classList.remove("fr-fieldset--error"),e.querySelector(".fr-error-text").classList.add("fr-hidden"))})),l(i)&&i.querySelector('[role="alert"]').classList.add("fr-hidden")}))):i.querySelectorAll('input,textarea,select,fieldset[aria-required="true"]').forEach((e=>{if("FIELDSET"===e.tagName)a(i)||(e.addEventListener("change",(()=>{a(i)})),invalid=e.parentElement);else if(!e.checkValidity()){let t=e.parentElement;"radio"===e.type&&(t=e.parentElement.parentElement.parentElement),[e.classList,t.classList].forEach((e=>{e.add(e[0]+"--error")})),t?.querySelector(".fr-error-text")?.classList.remove("fr-hidden"),e.addEventListener("input",(()=>{e.checkValidity()&&([e.classList,t.classList].forEach((e=>{e.remove(e[0]+"--error")})),t.querySelector(".fr-error-text")?.classList.add("fr-hidden"))})),invalid=i?.querySelector("*:invalid:first-of-type")?.parentElement}})),invalid){const e=invalid.getBoundingClientRect().top+window.scrollY;window.scroll({top:e,behavior:"smooth"})}}))})),document?.querySelectorAll(".fr-tabs__panel")?.forEach((e=>{e.addEventListener("dsfr.conceal",(()=>{"signalement-step-1-panel"===e.id&&e.querySelectorAll('[aria-expanded="true"]').forEach((e=>{r.setItem(e.id,"true")}));const t=e.getBoundingClientRect().top+window.scrollY;window.scroll({top:t,behavior:"smooth"})}))})),document?.querySelectorAll("[data-goto-step]")?.forEach((e=>{e.addEventListeners("click touchdown",(t=>{var r;t.preventDefault(),r=e.getAttribute("data-goto-step"),document.querySelector("#signalement-step-"+r).click()}))})),document?.querySelectorAll(".toggle-criticite-smiley").forEach((e=>{e.addEventListener("change",(e=>{let t=e.target.labels[0]?.parentElement?.querySelector(".fr-radio-rich__img img");e.target.parentElement.parentElement.querySelectorAll(".fr-radio-rich__img img").forEach((e=>{e.src=e.getAttribute("data-fr-unchecked-icon")})),!0===e.target.checked&&(t.src=e.target.parentElement.querySelector(".fr-radio-rich__img img").getAttribute("data-fr-checked-icon"))}))})),document?.querySelector("#signalement-step-1-panel")?.addEventListener("dsfr.disclose",(e=>{e.target.querySelectorAll("[aria-expanded]").forEach((e=>{r.getItem(e.id)&&(document.querySelector("#"+e.id).setAttribute("aria-expanded","true"),r.removeItem(e.id))}))}));
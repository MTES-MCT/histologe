let invalid,table,thead,headers,i,j,tables=document.querySelectorAll("table.sortable");for(i=0;i<tables.length;i++)if(table=tables[i],thead=table.querySelector("thead")){for(headers=thead.querySelectorAll("th"),j=0;j<headers.length;j++)headers[j].innerHTML="<a href='#'>"+headers[j].innerText+"</a>";thead.addEventListener("click",sortTableFunction(table))}forms.forEach((e=>{e?.querySelectorAll('.toggle-criticite input[type="radio"]')?.forEach((e=>{e.addEventListener("change",(e=>{e.currentTarget.parentElement.parentElement.parentElement.querySelector(".fr-toggle__input").checked=!0}))})),e?.querySelectorAll(".fr-toggle")?.forEach((e=>{e.addEventListener("change",(e=>{console.log("toggle"),e.target.checked||e.currentTarget.nextElementSibling.querySelectorAll('.fr-collapse input[type="radio"]').forEach((e=>{e.checked=!1,e.required=!1}))}))})),e?.querySelectorAll(".fr-hover-critere")?.forEach((t=>{t.addEventListeners("click touchdown",(r=>{if("true"===t.parentElement.parentElement.getAttribute("aria-expanded")){let r=e?.querySelector("#"+t.parentElement.parentElement.getAttribute("aria-controls"));r.classList.remove("fr-fieldset--error"),r.querySelectorAll("input").forEach((e=>{e.required=!1,e.checked=!1})),r.querySelectorAll(".fr-radio-rich img").forEach((e=>{e.src=e.getAttribute("data-fr-unchecked-icon")}))}}))})),e?.querySelectorAll(".fr-accordion__title")?.forEach((e=>{e.addEventListeners("click touchdown",(e=>{e.target.parentElement.parentElement.querySelectorAll('[type="radio"],[type="checkbox"]').forEach((e=>{e.checked=!1}))}))})),e?.querySelectorAll("[data-fr-toggle-show],[data-fr-toggle-hide]")?.forEach((t=>{t.addEventListener("change",(t=>{let r=t.target.getAttribute("data-fr-toggle-show"),a=t.target.getAttribute("data-fr-toggle-hide"),l=t.target.getAttribute("data-fr-toggle-unrequire"),n=t.target.getAttribute("data-fr-toggle-require");r&&r.split("|").map((t=>{let r;"signalement-consentement-tiers-bloc"===t?(r=document?.querySelector("#signalement-consentement-tiers-bloc"),r.querySelector('[type="checkbox"]').required=!0):(r=e?.querySelector("#"+t),r.querySelectorAll('input:not([type="checkbox"]),textarea,select').forEach((e=>{"signalement[numAllocataire]"!==e.name&&(e.required=!0,e.labels&&e.labels[0].classList.add("required"))}))),"signalement-methode-contact"===r.id&&r.querySelector("fieldset").setAttribute("aria-required",!0),r.classList.remove("fr-hidden")})),a&&a.split("|").map((t=>{let r;"signalement-consentement-tiers-bloc"===t?(r=document.querySelector("#signalement-consentement-tiers-bloc"),r.querySelector('[type="checkbox"]').required=!1):(r=e?.querySelector("#"+t),r?.querySelectorAll('input:not([type="checkbox"]),textarea,select')?.forEach((e=>{e.required=!1}))),"signalement-methode-contact"===r.id&&(r?.querySelector('fieldset[aria-required="true"]')?.removeAttribute("aria-required"),r?.querySelectorAll('[type="checkbox"]')?.forEach((e=>{e.checked=!1}))),r.classList.add("fr-hidden")})),l&&l.split("|").map((t=>{let r=e?.querySelector("#"+t);r||(r=document?.querySelector("#"+t)),r.required=!1,r?.parentElement?.classList?.remove("fr-input-group--error"),r?.parentElement?.querySelector(".fr-error-text")?.classList.add("fr-hidden"),r?.classList?.remove("fr-input--error"),r.labels[0].classList.remove("required")})),n&&n.split("|").map((t=>{let r=e?.querySelector("#"+t);r||(r=document?.querySelector("#"+t)),r.required=!0,r?.labels[0]?.classList.add("required")}))}))})),e?.querySelectorAll('input[type="file"]')?.forEach((e=>{e.addEventListener("change",(e=>{if(e.target.files.length>0){let t=e.target.parentElement.nextElementSibling;console.log(t);let r=new FormData,a=e.target.parentElement.parentElement.querySelector(".signalement-uploadedfile-delete"),l=e.target?.parentElement?.querySelector("img"),n=!1,o=e.target.files[0],i=e.target.id,c=document.querySelector("#progress_"+i),s=document.querySelector("#form_global_file_progress");if(console.log(o),l?(l.src=URL.createObjectURL(o),["fr-fi-instagram-line","fr-py-7v","fr-fi-refresh-line","fr-disabled"].map((t=>e.target.parentElement.classList.toggle(t))),n=!0):e.target.parentElement.classList.contains("fr-fi-attachment-fill")&&(e.target.files[0].size>10485760?t.classList.remove("fr-hidden"):(t.classList.add("fr-hidden"),n=!0,["fr-fi-attachment-fill","fr-fi-refresh-line","fr-disabled"].map((t=>e.target.parentElement.classList.toggle(t))))),n){a.addEventListeners("click touchdown",(n=>{n.preventDefault(),l?(l.src="#",e.target.parentElement.classList.add("fr-fi-instagram-line")):e.target.parentElement.classList.contains("fr-fi-checkbox-circle-fill")?["fr-fi-attachment-fill","fr-fi-checkbox-circle-fill"].map((t=>e.target.parentElement.classList.toggle(t))):e.target.parentElement.classList.add("fr-fi-attachment-fill"),e.target.value="",r.delete(e.target.name),delete uploadedFiles[e.target.id],[l,a].forEach((e=>e?.classList.add("fr-hidden"))),e.target.parentElement.classList.remove("fr-disabled"),t.innerText=""})),r.append(e.target.name,o);let n=new XMLHttpRequest,d=document.querySelector("#form_finish_submit");n.open("POST",e.target.getAttribute("data-handle-url")),n.upload.addEventListener("progress",(function(e){s.classList.remove("fr-hidden"),d.disabled=!0,d.innerHTML="Téléversement en cours, veuillez patienter....";let t=document.querySelectorAll("progress:not(.fr-hidden,.final-progress)"),r=e.loaded/e.total*100,a=0;t.forEach((e=>{a+=e.value})),s.value=a/t.length,console.log(i),c.value=r,console.log(r)})),n.addEventListener("load",(function(r){console.log(n.status),console.log(n.response),e.target.parentElement.classList.remove("fr-fi-refresh-line"),[l,a].forEach((e=>e?.classList?.remove("fr-hidden"))),c.value=0;let o=JSON.parse(n.response);200!==n.status?(t.innerText=o.error,t.classList.remove("fr-hidden"),t.classList.add("fr-text-label--red-marianne"),c.value=0,a.click()):(t.innerText=o.titre,t.classList.remove("fr-hidden"),t.classList.add("fr-text-label--green-emeraude"),l||["fr-fi-checkbox-circle-fill"].map((t=>e.target.parentElement.classList.toggle(t))),uploadedFiles[e.target.id]=n.response),c.classList.add("fr-hidden"),e.target.value="",document.querySelectorAll("progress:not(.fr-hidden,.final-progress)").length<1&&(s.classList.add("fr-hidden"),d.innerHTML="Confirmer",d.disabled=!1)})),c.classList.remove("fr-hidden"),n.send(r),e.target.parentElement.classList.add("fr-disabled")}}}))})),e?.querySelectorAll("[data-fr-adresse-autocomplete]").forEach((t=>{t.addEventListener("keyup",(()=>{searchAddress(e,t)}))})),e.addEventListener("submit",(t=>{if(t.preventDefault(),e.checkValidity()&&checkFirstStep(e)&&checkFieldset(e))if(e.querySelectorAll("input,textarea,select").forEach((e=>{let t=e.parentElement;"radio"===e.type&&(t=e.parentElement.parentElement.parentElement),[e.classList,t.classList].forEach((e=>{e.remove(e[0]+"--error")})),t.querySelector(".fr-error-text")?.classList.add("fr-hidden")})),"signalement"!==e.name)Object.keys(uploadedFiles).map(((t,r)=>{let a=JSON.parse(uploadedFiles[t]);e.insertAdjacentHTML("beforeend",`<input type="hidden" name="signalement[files][${a.key}][${a.titre}]" value="${a.file}">`)})),e.submit();else{let r=document.querySelector('.fr-tabs__list>li>button[aria-selected="true"]').parentElement?.nextElementSibling?.querySelector("button");if(r){if(r.hasAttribute("data-fr-last-step")){let e,t;e=t=0,document.querySelector("#recap-signalement-situation").innerHTML="",forms.forEach((r=>{r.querySelectorAll('[type="file"]').forEach((r=>{r.classList.contains("doc-file")&&(e+=r.files.length),r.classList.contains("photo-file")&&(t+=r.files.length)})),document.querySelector("#recap-signalement_photos").innerHTML=t+" Photo(s) transmise(s)",document.querySelector("#recap-signalement_documents").innerHTML=e+" Document(s) transmis",r.querySelectorAll("input,textarea,select").forEach((e=>{document.querySelector("#recap-"+e.id)?(console.log(document.querySelector("#recap-"+e.id)),document.querySelector("#recap-"+e.id).innerHTML=`${e.value}`):e.classList.contains("signalement-situation")&&e.checked&&(document.querySelector("#recap-signalement-situation").innerHTML+="- "+e.value+"<br>")}))}))}r.disabled=!1,r.click()}if(!r){t.target.querySelector('[type="submit"]').disabled=!0,["fr-fi-checkbox-circle-fill","fr-fi-refresh-fill"].map((e=>t.target.querySelector('[type="submit"]').classList.toggle(e))),t.target.querySelector('[type="submit"]').innerHTML="En cours d'envoi...";let r=new FormData;forms.forEach((e=>{let t=serializeArray(e);for(let e=0;e<Object.keys(t).length;e++){let a=Object.keys(t)[e],l=Object.values(t)[e];"signalement[photos]"!==a&&"signalement[documents]"!==a&&r.append(a,l)}})),Object.keys(uploadedFiles).map(((e,t)=>{let a=JSON.parse(uploadedFiles[e]);r.append(`signalement[files][${a.key}][${a.titre}]`,a.file)})),fetch(e.action,{method:"POST",body:r}).then((e=>{e.ok?e.json().then((e=>{"success"===e.response?(document.querySelectorAll("#signalement-tabs,#signalement-success").forEach((e=>{e.classList.toggle("fr-hidden")})),localStorage.clear()):"success_edited"===e.response?(localStorage.clear(),window.location.reload()):(t.target.querySelector('[type="submit"]').disabled=!1,t.target.querySelector('[type="submit"]').innerHTML="Confirmer",["fr-fi-checkbox-circle-fill","fr-fi-refresh-fill"].map((e=>t.target.querySelector('[type="submit"]').classList.toggle(e))),alert("Erreur lors de l'enregistrement du  signalement !"))})):(t.target.querySelector('[type="submit"]').disabled=!1,t.target.querySelector('[type="submit"]').innerHTML="Confirmer",["fr-fi-checkbox-circle-fill","fr-fi-refresh-fill"].map((e=>t.target.querySelector('[type="submit"]').classList.toggle(e))),alert("Erreur lors de l'enregistrement du  signalement ! Nos équipes ont été informées du problème."))}))}}else if(t.stopPropagation(),"signalement-step-2"===e.id?(e.querySelector('[role="alert"]').classList.remove("fr-hidden"),e?.querySelectorAll(".fr-fieldset__content.fr-collapse.fr-collapse--expanded").forEach((e=>{e.querySelector('[type="radio"]:first-of-type').required=!0,e.querySelector("input:invalid")&&(e.classList.add("fr-fieldset--error"),e.querySelector(".fr-error-text").classList.remove("fr-hidden"))})),invalid=e?.querySelector("*:invalid:first-of-type")?.parentElement,invalid||(invalid=document.querySelector("div[role='alert']")),e.addEventListener("change",(()=>{e?.querySelectorAll(".fr-fieldset__content.fr-collapse.fr-collapse--expanded").forEach((e=>{null===e.querySelector("input:invalid")&&(e.classList.remove("fr-fieldset--error"),e.querySelector(".fr-error-text").classList.add("fr-hidden"))})),checkFirstStep(e)&&e.querySelector('[role="alert"]').classList.add("fr-hidden")}))):e.querySelectorAll('input,textarea,select,fieldset[aria-required="true"]').forEach((t=>{if("FIELDSET"===t.tagName)checkFieldset(e)||(t.addEventListener("change",(()=>{checkFieldset(e)})),invalid=t.parentElement);else if(!t.checkValidity()){let r=t.parentElement;"radio"===t.type&&(r=t.parentElement.parentElement.parentElement),[t.classList,r.classList].forEach((e=>{e.add(e[0]+"--error")})),r?.querySelector(".fr-error-text")?.classList.remove("fr-hidden"),t.addEventListener("input",(()=>{t.checkValidity()&&([t.classList,r.classList].forEach((e=>{e.remove(e[0]+"--error")})),r.querySelector(".fr-error-text")?.classList.add("fr-hidden"))})),invalid=e?.querySelector("*:invalid:first-of-type")?.parentElement}})),invalid){const e=invalid.getBoundingClientRect().top+window.scrollY;window.scroll({top:e,behavior:"smooth"})}}))})),document?.querySelectorAll(".fr-tabs__panel")?.forEach((e=>{e.addEventListener("dsfr.conceal",(()=>{"signalement-step-2-panel"===e.id&&e.querySelectorAll('[aria-expanded="true"]').forEach((e=>{localStorage.setItem(e.id,"true")}));const t=e.getBoundingClientRect().top+window.scrollY;window.scroll({top:t,behavior:"smooth"})}))})),document?.querySelectorAll("[data-goto-step]")?.forEach((e=>{e.addEventListeners("click touchdown",(t=>{t.preventDefault(),goToStep(e.getAttribute("data-goto-step"))}))})),document?.querySelectorAll(".toggle-criticite-smiley").forEach((e=>{e.addEventListener("change",(e=>{let t=e.target.labels[0]?.parentElement?.querySelector(".fr-radio-rich__img img");e.target.parentElement.parentElement.querySelectorAll(".fr-radio-rich__img img").forEach((e=>{e.src=e.getAttribute("data-fr-unchecked-icon")})),!0===e.target.checked&&(t.src=e.target.parentElement.querySelector(".fr-radio-rich__img img").getAttribute("data-fr-checked-icon"))}))})),document?.querySelector("#signalement-step-2-panel")?.addEventListener("dsfr.disclose",(e=>{e.target.querySelectorAll("[aria-expanded]").forEach((e=>{localStorage.getItem(e.id)&&(document.querySelector("#"+e.id).setAttribute("aria-expanded","true"),localStorage.removeItem(e.id))}))})),document?.querySelectorAll(".fr-pagination__link:not([aria-current])").forEach((e=>{let t,r,a,l=document.querySelector(".fr-pagination__link--prev"),n=document.querySelector(".fr-pagination__link--next"),o=document.querySelector(".fr-pagination__link--first"),i=document.querySelector(".fr-pagination__link--last"),c=1,s=parseInt(i.getAttribute("data-page"));e.addEventListener("click",(e=>{let d=new FormData(document.querySelector('form[name="bo-filters-form"]'));d.append("pagination","true");let u=document?.querySelector(".fr-pagination__link[aria-current]"),m=e.target;m!==l&&m!==n&&m!==o&&m!==i?c=parseInt(m.getAttribute("data-page")):m===n?c=parseInt(u.getAttribute("data-page"))+1:m===l?c=parseInt(u.getAttribute("data-page"))-1:m===i?c=parseInt(s):m===o&&(c=parseInt(1)),d.append("page",c),t=document.querySelector('.fr-pagination__link[data-page="'+c+'"]'),fetch("#",{method:"POST",body:d}).then((e=>e.text().then((e=>{let d=document.querySelector("#signalements-result");d.innerHTML=e,d.querySelectorAll("tr").forEach((e=>{gauge=new Gauge(e.querySelector(".gauge-signalement")).setOptions(opts),gauge.set(e.getAttribute("data-score"))})),u.removeAttribute("aria-current"),u.href="#",t.removeAttribute("href"),t.setAttribute("aria-current","page"),1!==c&&c!==s?r=[o,l,n,i]:1===c?(r=[n,i],a=[o,l]):c===s&&(r=[o,l],a=[n,i]),r.forEach((e=>{e.removeAttribute("aria-disabled"),e.href="#"})),a&&a.forEach((e=>{e.removeAttribute("href"),e.setAttribute("aria-disabled","true")}))}))))}))})),document?.querySelectorAll('[data-removable="true"]')?.forEach((e=>{e.addEventListener("click",(()=>{removeBadge(e)}))})),document?.querySelectorAll("[data-fr-select-target]")?.forEach((e=>{let t=document?.querySelector("#"+e.getAttribute("data-fr-select-source")),r=document?.querySelector("#"+e.getAttribute("data-fr-select-target"));e.addEventListeners("click touchdown",(()=>{[...t.selectedOptions].map((e=>{r.append(e)}))}))})),document?.querySelector("#signalement-affectation-form-submit")?.addEventListeners("click touchdown",(e=>{e.preventDefault(),e.target.disabled=!0,e.target?.form?.querySelectorAll("option").forEach((e=>{e.selected=!0})),document?.querySelectorAll("#signalement-affectation-form-row,#signalement-affectation-loader-row").forEach((e=>{e.classList.toggle("fr-hidden")}));let t=new FormData(e.target.form);fetch(e.target.getAttribute("formaction"),{method:"POST",body:t}).then((e=>{e.ok&&window.location.reload(!0)}))})),document?.querySelectorAll(".fr-input--file-signalement").forEach((e=>{e.addEventListener("change",(e=>{e.target.form.submit()}))})),document?.querySelector("#partenaire_add_user,#situation_add_critere")?.addEventListeners("click touchdown",(e=>{let t,r,a,l,n;e.preventDefault(),"partenaire_add_user"===e.target.id?(t=document.importNode(document.querySelector("#partenaire_add_user_row").content,!0),r=document.querySelector("#partenaire_add_user_placeholder"),n="partner-row-user",a=r.querySelectorAll("."+n)?.length):(t=document.importNode(document.querySelector("#situation_add_critere_row").content,!0),r=document.querySelector("#situation_add_critere_placeholder"),n="situation-row-critere",a=r.querySelectorAll("."+n)?.length),l=document.createElement("div"),l.classList.add("fr-grid-row","fr-grid-row--gutters","fr-grid-row--middle","fr-background-alt--blue-france","fr-mb-5v",n),t.querySelectorAll("label,input,select,button,textarea").forEach((e=>{e.id=e?.id?.replaceAll("__ID__",a),e.name=e?.name?.replaceAll("__ID__",a),"LABEL"===e.tagName&&e.setAttribute("for",e.getAttribute("for").replaceAll("__ID__",a)),"BUTTON"===e.tagName&&e.addEventListeners("click touchdown",(e=>{e.target.closest("."+n).remove()}))})),l.appendChild(t),r.appendChild(l)})),document?.querySelectorAll("[data-tag-delete]")?.forEach((e=>{e.addEventListener("click",deleteTagEvent)})),document?.querySelectorAll("[data-delete]")?.forEach((e=>{e.addEventListeners("click touchdown",(t=>{let r;if(t.preventDefault(),t.target.classList.contains("partner-user-delete")?r=".partner-row-user":t.target.classList.contains("situation-critere-delete")?r=".situation-row-critere":t.target.classList.contains("signalement-file-delete")?r=".signalement-file-item":t.target.classList.contains("signalement-row-delete")?r=".signalement-row":t.target.classList.contains("partner-row-delete")&&(r=".partner-row"),confirm("Voulez-vous vraiment supprimer cet élément ?")){let t=new FormData;t.append("_token",e.getAttribute("data-token"));let a=e.getAttribute("data-value")??null;a&&(t.append("item","Tag"),t.append("value",a)),fetch(e.getAttribute("data-delete"),{method:"POST",body:t}).then((t=>{t.ok&&e.closest(r).remove()}))}}))})),document?.querySelectorAll(".fr-password-toggle")?.forEach((e=>{e.addEventListeners("click touchdown",(e=>{["fr-fi-eye-off-fill","fr-fi-eye-fill"].map((t=>{e.target.classList.toggle(t)}));let t=e.target.parentElement.querySelector('[name^="password"]');"text"!==t.type?t.type="text":t.type="password"}))})),document?.querySelector('form[name="login-creation-mdp-form"]')?.querySelectorAll('[name^="password"]').forEach((e=>{e.addEventListener("input",(()=>{let e=document?.querySelector('form[name="login-creation-mdp-form"] #login-password').value,t=document?.querySelector('form[name="login-creation-mdp-form"] #login-password-repeat').value,r=document?.querySelector('form[name="login-creation-mdp-form"] #password-match-error'),a=document?.querySelector('form[name="login-creation-mdp-form"] #submitter');a.addEventListener("click",(e=>{e.preventDefault()})),e!==t?(document?.querySelector('form[name="login-creation-mdp-form"]').querySelectorAll(".fr-input-group").forEach((e=>{e.classList.add("fr-input-group--error"),e.querySelector(".fr-input").classList.add("fr-input--error")})),a.disabled=!0,r.classList.remove("fr-hidden")):(document?.querySelector('form[name="login-creation-mdp-form"]').querySelectorAll(".fr-input-group--error,.fr-input--error").forEach((e=>{["fr-input-group--error","fr-input--error"].map((t=>{e.classList.remove(t)}))})),r.classList.add("fr-hidden"),a.disabled=!1)}))})),document.querySelector("#modal-dpe-opener")?.addEventListener("click",(e=>{let t=e.target.getAttribute("data-dpe-url");fetch(t).then((e=>{e.json().then((e=>{if(e.total>1){let t=document.querySelector("#modal-dpe-content");t.innerHTML="",e.aggs.map((e=>{e.results.map((e=>{let r=e.classe_consommation_energie;if("N"!==r){console.log(e);let a=e.classe_estimation_ges,l=document.createElement("div"),n=document.createElement("img"),o=document.createElement("img");n.src="/img/dpe_"+r+".png",o.src="/img/ges_"+a+".png",t.append(l),l.insertAdjacentHTML("beforeend",`<h5 class="fr-h3 fr-col-12 fr-mb-0">${e.date_etablissement_dpe}</h5>`),l.insertAdjacentHTML("beforeend",`<h6>Consommation énergie ${e.consommation_energie}</h6>`),[n,o].map((e=>{e.classList.add("fr-col-6")})),l.append(n,o)}}))}))}}))}))})),document.querySelectorAll(".value-switcher").forEach((e=>{e.addEventListener(e.getAttribute("data-action")??"change",(e=>{let t=e.target.getAttribute("data-url"),r=new FormData;r.append("_token",e.target.getAttribute("data-token")),r.append("item",e.target.getAttribute("data-item")),r.append("value",e?.target?.selectedIndex?e?.target?.options[e?.target?.selectedIndex]?.value:""),fetch(t,{method:"POST",body:r}).then((t=>t.json().then((t=>{1===t.return&&(["fr-badge--error","fr-badge--success"].map((t=>{e.target.classList.toggle(t)})),"OUI"===e.target.innerText?e.target.innerText="NON":e.target.innerText="OUI")}))))}))}));
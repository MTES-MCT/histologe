let idFetchTimeout;
Node.prototype.addEventListeners=function(e,t){for(let r of e.split(" "))this.addEventListener(r,t)};const addTagEvent=e=>{e.target.removeEventListener("click",addTagEvent,!0);let t=new FormData;t.append("_token",e.target.getAttribute("data-token")),t.append("item","Tag"),t.append("value",e.target.getAttribute("data-value")),e.target.getAttribute("data-tag-add")&&fetch(e.target.getAttribute("data-tag-add"),{method:"POST",body:t}).then((t=>{if(t.ok){let t=document.querySelector("#tags_active_container");["fr-fi-close-line","fr-fi-add-line"].forEach((t=>{e.target.classList.toggle(t)})),e.target.setAttribute("data-tag-delete",e.target.getAttribute("data-tag-add")),e.target.removeAttribute("data-tag-add"),t.querySelector("em").classList.add("fr-hidden");let r=e.target?.querySelector("span.tag--deleter.fr-hidden");r?.classList?.add("fr-hidden"),r?.removeEventListener("click",persistRemoveTagEvent,!0),t.appendChild(e.target),e.target.addEventListener("click",deleteTagEvent)}}))},deleteTagEvent=e=>{e.target.removeEventListener("click",deleteTagEvent,!0);let t=new FormData;t.append("_token",e.target.getAttribute("data-token")),t.append("item","Tag"),t.append("value",e.target.getAttribute("data-value")),e.target.getAttribute("data-tag-delete")&&fetch(e.target.getAttribute("data-tag-delete"),{method:"POST",body:t}).then((t=>{if(t.ok){document.querySelector("#tags_select_tooltip_btn")._tippy.show();let t=document.querySelector("#tags_inactive_container");["fr-fi-close-line","fr-fi-add-line"].forEach((t=>{e.target.classList.toggle(t)})),e.target.setAttribute("data-tag-add",e.target.getAttribute("data-tag-delete")),e.target.removeAttribute("data-tag-delete");let r=e.target?.querySelector("span.tag--deleter.fr-hidden");r?.classList?.remove("fr-hidden"),r?.addEventListener("click",persistRemoveTagEvent),t.appendChild(e.target),document.querySelector("#tags_active_container").querySelector(".fr-badge")||document.querySelector("#tags_active_container").querySelector("em").classList.remove("fr-hidden"),e.target.addEventListener("click",addTagEvent)}}))},persistRemoveTagEvent=e=>{let t=e.target.parentElement,r=t.getAttribute("data-value"),a=t.getAttribute("data-remove-url").replace("__ID__",r);confirm("Êtes-vous certains de vouloir supprimer ce tag ?\nCette action est irréversible.")&&fetch(a).then((e=>{e.ok&&t.remove()}))},forms=document.querySelectorAll('form.needs-validation:not([name="bug-report"])'),localStorage=window.localStorage,uploadedFiles=[],checkUserMail=e=>{let t=new FormData;t.append("email",e.value),t.append("_token",e.getAttribute("data-token")),fetch("/bo/partner/checkmail",{method:"POST",body:t}).then((t=>{t.ok?(e.classList.remove("fr-input--error"),e.parentElement.classList.remove("fr-input-group--error"),e.parentElement.querySelector("p.fr-error-text").classList.add("fr-hidden"),document.querySelector("#submit_btn_partner").disabled=!1):(e.classList.add("fr-input--error"),e.parentElement.classList.add("fr-input-group--error"),e.parentElement.querySelector("p.fr-error-text").classList.remove("fr-hidden"),document.querySelector("#submit_btn_partner").disabled=!0)}))},serializeArray=e=>Array.from(new FormData(e).entries()).reduce((function(e,t){return e[t[0]]=t[1],e}),{}),checkFirstStep=e=>!("signalement-step-2"===e.id&&null===e.querySelector('[type="radio"]:checked')||"signalement-step-2"===e.id&&e.querySelectorAll('[type="checkbox"]:checked').length!==e.querySelectorAll('[type="radio"]:checked').length),checkFieldset=e=>{let t=e.querySelector('fieldset[aria-required="true"]');return!t||(null===t.querySelector('[type="checkbox"]:checked')?(t.classList.add("fr-fieldset--error"),t?.querySelector(".fr-error-text")?.classList.remove("fr-hidden"),invalid=t.parentElement,!1):(t.classList.remove("fr-fieldset--error"),t?.querySelector(".fr-error-text")?.classList.add("fr-hidden"),!0))},goToStep=e=>{document.querySelector("#signalement-step-"+e+"-btn").click()},sortTableFunction=e=>function(t){"a"==t.target.tagName.toLowerCase()&&(sortRows(e,siblingIndex(t.target.parentNode)),t.preventDefault())},siblingIndex=e=>{let t=0;for(;e=e.previousElementSibling;)t++;return t},sortRows=(e,t)=>{let r,a,l,n=e.querySelectorAll("tbody tr"),o="thead th:nth-child("+(t+1)+")",d="td:nth-child("+(t+1)+")",s=e.querySelector(o).classList,i=[],c="",u=!0;for(s&&(s.contains("date")?c="date":s.contains("number")&&(c="number")),a=0;a<n.length;a++)l=n[a].querySelector(d),r=l.innerText,isNaN(r)?u=!1:r=parseFloat(r),i.push({value:r,row:n[a]});""==c&&u&&(c="number"),"number"==c?(i.sort(sortNumberVal),i=i.reverse()):"date"==c?i.sort(sortDateVal):i.sort(sortTextVal);for(let t=0;t<i.length;t++)e.querySelector("tbody").appendChild(i[t].row)},sortNumberVal=(e,t)=>sortNumber(e.value,t.value),sortNumber=(e,t)=>e-t,sortDateVal=(e,t)=>{let r=Date.parse(e.value),a=Date.parse(t.value);return sortNumber(r,a)},sortTextVal=(e,t)=>{let r=(e.value+"").toUpperCase(),a=(t.value+"").toUpperCase();return r<a?-1:r>a?1:0},setBadge=e=>{let t=e.parentElement.querySelector(".selected__value");if(""!==e.value){let r=document.createElement("span");r.classList.add("fr-badge","fr-badge--success","fr-m-1v"),r.innerText=e.selectedOptions[0].text;let a=document.createElement("input");a.type="hidden",a.name=`${e.id}[]`,a.value=e.value,t.append(a),r.setAttribute("data-value",e.value),t.querySelector(".fr-badge:not([data-value])")?.classList?.add("fr-hidden"),t.append(r),e.selectedOptions[0].classList.add("fr-hidden"),r.addEventListener("click",(e=>{removeBadge(r)}))}else t.querySelectorAll(".fr-badge[data-value]").forEach((e=>{removeBadge(e)}));return!1},removeBadge=e=>{let t=e.getAttribute("data-value"),r=e.parentElement.querySelector(`input[value="${t}"]`),a=e?.parentElement?.parentElement?.querySelector("select")??e?.parentElement?.parentElement?.querySelector('input[type="date"]');a.querySelector(`option[value="${t}"]`)?.classList?.remove("fr-hidden"),r?.remove();let l=1!==e.parentElement.querySelectorAll(".fr-badge[data-value]").length;console.log(e.parentElement.querySelectorAll(".fr-badge[data-value]").length),l||(e?.parentElement?.querySelector(".fr-badge:not([data-value])")?.classList?.remove("fr-hidden"),"SELECT"===a.tagName&&(a.options[0].selected=!0)),e.remove()},


searchAddress=(e,t)=>{
    clearTimeout(idFetchTimeout);
    idFetchTimeout = setTimeout( () => {
        if(t.value.length>10)return t.removeEventListener("keyup",searchAddress),
        fetch("https://api-adresse.data.gouv.fr/search/?q="+t.value).then(
            (t=>{t.json().then((t=>{let r=e.querySelector("#signalement-adresse-suggestion");r.innerHTML="";for(let a of t.features){let t=document.createElement("div");t.classList.add("fr-col-12","fr-p-3v","fr-text-label--blue-france","fr-adresse-suggestion"),t.innerHTML=a.properties.label,t.addEventListener("click",(()=>{e.querySelector("#signalement_adresseOccupant").value=a.properties.name,e.querySelector("#signalement_cpOccupant").value=a.properties.postcode,e.querySelector("#signalement_villeOccupant").value=a.properties.city,e.querySelector("#signalement-insee-occupant").value=a.properties.citycode,e.querySelector("#signalement-geoloc-lat-occupant").value=a.geometry.coordinates[0],e.querySelector("#signalement-geoloc-lng-occupant").value=a.geometry.coordinates[1],r.innerHTML=""

            // dirty change because we dont know how to minify this file ; will disappear when refacto
            if (a.properties.citycode.substr(0, 2) == '69') {
                const METROPOLE_RHONES_AUTHORIZED_INSEE_CODES = [
                    69091, 69096, 69123, 69149, 69199, 69205, 69290, 69259, 69266,
                    69381, 69382, 69383, 69384, 69385, 69386, 69387, 69388, 69389,
                    69901 ];
                const COR_RHONES_AUTHORIZED_INSEE_CODES = [
                    69001, 69006, 69008, 69037, 69054, 69060, 69066, 69070, 69075,
                    69093, 69102, 69107, 69174, 69130, 69160, 69164, 69169, 69181,
                    69183, 69188, 69200, 69214, 69217, 69225, 69229, 69234, 69240,
                    69243, 69248, 69254, 69157
                ];

                const RHONES_AUTHORIZED_INSEE_CODES = METROPOLE_RHONES_AUTHORIZED_INSEE_CODES.concat(
                    COR_RHONES_AUTHORIZED_INSEE_CODES
                );

                if (RHONES_AUTHORIZED_INSEE_CODES.indexOf(Number(a.properties.citycode)) == -1) {
                    e.querySelector('#fr-error-text-insee')?.classList?.remove('fr-hidden');
                } else {
                    e.querySelector('#fr-error-text-insee')?.classList?.add('fr-hidden');
                }
            }

            })),r.appendChild(t)}}))})
        ),!1
    }, 300 );
};
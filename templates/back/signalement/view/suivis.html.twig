<hr class="fr-mt-3w">

<div id="suivis" class="fr-grid-row">
    <div class="fr-col-9 fr-col-md-6">
        <h3 class="fr-h5">Suivis</h3>
        <div class="fr-toggle fr-mb-3v">
            <input type="checkbox" id="toggle-hide-technical" name="toggle-hide-technical">
            <label class="fr-toggle__label" for="toggle-hide-technical">Cacher les suivis automatiques</label>
        </div>
    </div>
    {% if is_granted('CREATE_SUIVI', signalement) %}
        <div data-ajax-form>
            {% include '_partials/signalement/add_suivi.html.twig' %}
        </div>
        <div class="fr-col-3 fr-col-md-6 fr-text--right">
            <button class="fr-btn fr-btn--icon-left fr-icon-quote-line" data-fr-opened="false"
                    aria-controls="fr-modal-add-suivi">
                Ajouter un suivi
            </button>
        </div>
    {% endif %}
</div>

{% for suivi in signalement.suivis|reverse %}
    <div class="fr-grid-row fr-grid-row--middle fr-background-alt--blue-france fr-border-background-action-high-blue-france fr-p-3v fr-mb-3v suivi-item
        {% if suivi.type is same as constant('App\\Entity\\Suivi::TYPE_TECHNICAL') %}suivi-auto{% endif %}
        {% if loop.index > 3 %}fr-hidden{% endif %}
        ">
        <div class="fr-col-3">
            <strong {% if app.user.isSuperAdmin or app.environment == 'dev' %} title="{{ suivi.createdAt|date('d/m/Y H:i:s') }}" {% endif %}>
                {{ suivi.createdAt|date('d/m/Y') }}
            </strong>            <br>
            {% if suivi.createdBy is not null %}
                <span class="fr-tooltip fr-placement" id="tooltip_suivi_{{ suivi.id }}" role="tooltip">
                    <strong class="fr-ws-nowrap">{{ suivi.createdBy.nomComplet }}</strong>
                    <hr class="fr-pb-1v">
                    <span class="fr-ws-nowrap">{{ suivi.createdBy.email }}</span>
                    {% if suivi.createdBy.fonction %}
                        <hr class="fr-pb-1v">
                        <span class="fr-ws-nowrap">{{ suivi.createdBy.fonction }}</span>
                    {% endif %}
                    {% if suivi.createdBy.phone %}
                        <hr class="fr-pb-1v">
                        <span class="fr-ws-nowrap">{{ suivi.createdBy.phoneDecoded }}</span>
                    {% endif %}
                </span>
                <span aria-describedby="tooltip_suivi_{{ suivi.id }}">
                    {{ suivi.getCreatedByLabel('\n')|nl2br }}
                </span>
            {% else %}
                {{ suivi.getCreatedByLabel('\n')|nl2br }}
            {% endif %}
        </div>

        <div class="fr-col-6 bloc-suivi-content-row fr-pl-3v">
        {{ transform_suivi_description(suivi)|raw}}
        </div>
        {% set nbCol = is_granted('DELETE_SUIVI', suivi) or is_granted('EDIT_SUIVI', suivi) ? '2' : '3' %}
        <div class="fr-col-{{ nbCol }}">
            {% if suivi.isPublic %}
                <span class="fr-badge fr-badge--no-icon" title="Visible par l'usager">Visible par l'usager</span>
            {% else %}
                <span class="fr-badge fr-badge--no-icon" title="Suivi interne">Suivi interne</span>
            {% endif %}
            <br>
            {% if suivi.isPublic and suivi.type is not same as constant('App\\Entity\\Suivi::TYPE_USAGER') %}
                <span class="fr-badge fr-badge--{{ suivi.isSeenByUsager ? 'success fr-background--notif-info' : 'error fr-background--notif-error' }} fr-mt-1v">{{ suivi.isSeenByUsager ? 'Lu' : 'Non lu' }}</span>
            {% endif %}
        </div>
        {% if is_granted('DELETE_SUIVI', suivi) or is_granted('EDIT_SUIVI', suivi) %}
            <div class="fr-col-1 fr-text--right">
                {% if is_granted('EDIT_SUIVI', suivi) %}
                    <button title="Modifier le suivi" 
                        class="fr-btn fr-btn--sm fr-btn--secondary fr-fi-edit-line btn-edit-suivi"
                        data-fr-opened="false"
                        aria-controls="fr-modal-edit-suivi"
                        data-url="{{ path('back_signalement_edit_suivi',{suivi:suivi.id}) }}"
                        >
                    </button>
                {% endif %}
                {% if is_granted('DELETE_SUIVI', suivi) %}
                    <button title="Supprimer le suivi"
                        data-delete="{{ path('back_signalement_delete_suivi',{uuid:signalement.uuid,suivi:suivi.id}) }}"
                        data-token="{{ csrf_token('signalement_delete_suivi_'~signalement.id) }}"
                        class="fr-btn fr-btn--sm fr-btn--secondary fr-fi-delete-line suivi-row-delete">
                    </button>
                {% endif %}
            </div>            
        {% endif %}
    </div>
{% endfor %}

{% if signalement.suivis|length > 3 %}
    <p class="fr-text--center">
        <a href="#" id="btn-display-all-suivis">Afficher tous les suivis</a>
    </p>
{% endif %}

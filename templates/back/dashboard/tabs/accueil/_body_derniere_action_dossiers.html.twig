{% set columns = [
    { class: 'fr-col-md-5', title: 'Référence' },
    { class: 'fr-col-md-4', title: 'Votre dernière action' },
    { class: 'fr-col-md-2', title: 'Action depuis' }
] %}

{% set firstColumnClass = is_granted('ROLE_ADMIN_TERRITORY') ? 'fr-col-md-8 fr-pr-10v' : 'fr-col-md-12' %}
<section class="fr-mb-5v">
    <div class="fr-grid-row fr-grid-row--gutters">
        <div class="{{ firstColumnClass }}">
            <h1 class="fr-mb-3v fr-text-label--blue-france tab-panel-title-with-calendar-icon">Vos dernières actions</h1>
            <hr class="hr--blue-france">
            <div class="fr-container--fluid">
                {% for item in items.data %}
                    {% set statutClass = item.statut == 'En cours'
                        ? 'fr-badge--success'
                        : (item.statut == 'En attente' ? 'fr-badge--info' : 'fr-badge--grey')
                    %}
                    {% set actionClass = item.actionDepuis == 'OUI'
                        ? 'fr-badge--success'
                        : 'fr-badge--error'
                    %}

                    {% set declarantInfo = item.reference ~ ' - ' ~ item.nomDeclarant|upper ~ ' ' ~ item.prenomDeclarant|capitalize %}
                    {% include 'back/dashboard/components/_card.html.twig' with {
                        data: [
                            '<div class="fr-text-label--blue-france">
                                <div><strong class="fr-text--lg">' ~ declarantInfo ~ '</strong></div>
                                <div>' ~ item.adresse ~ '</div>
                                <div class="fr-mt-1v">
                                    <span class="fr-badge ' ~ statutClass ~ ' fr-badge--no-icon">' ~ item.statut ~ '</span>
                                </div>
                            </div>',
                            '<div><strong class="fr-text--lg">' ~ item.derniereAction ~ '</strong></div><div>' ~ item.derniereActionAt ~ '</div>',
                            '<span class="fr-badge ' ~ actionClass ~ ' fr-badge--no-icon">' ~ item.actionDepuis ~ '</span>'
                        ],
                        link: item.lien
                    } %}
                {% endfor %}
            </div>
        </div>
        {% if is_granted('ROLE_ADMIN_TERRITORY') %}
            <div class="fr-col-12 fr-col-md-4">
                <h2 class="fr-mb-8v">Administrer mon territoire</h2>
                <div class="fr-grid-row fr-grid-row--gutters">
                    {% include 'back/dashboard/components/_tuile.html.twig' with {
                        icon_path: 'img/picto-dsfr/warning.svg',
                        title: 'Comptes bientôt archivés',
                        badge_class: 'fr-badge--error',
                        badge_label: items.data_kpi.comptes_en_attente ~ ' Compte' ~ (items.data_kpi.comptes_en_attente > 1 ? 's' : '')
                    } %}

                    {% include 'back/dashboard/components/_tuile.html.twig' with {
                        icon_path: 'img/picto-dsfr/notification.svg',
                        title: 'Partenaires non notifiables',
                        badge_class: 'fr-badge--info',
                        badge_label: items.data_kpi.partenaires_non_notifiables ~ ' Partenaire' ~ (items.data_kpi.partenaires_non_notifiables > 1 ? 's' : '')
                    } %}
                </div>
                <h2>Connexion SI externes</h2>
                {% set classNotice = items.data_interconnexion.hasErrorsLastDay ? 'warning' : 'info' %}
                <div class="fr-notice fr-notice--{{ classNotice }}">
                    <div class="fr-px-2v">
                        <div class="fr-notice__body">
                            <span class="fr-notice__title">
                                {{ items.data_interconnexion.hasErrorsLastDay
                                ? 'Une erreur de synchronisation a été détectée le ' ~ items.data_interconnexion.firstErrorLastDayAt
                                : 'Aucune erreur détectée ces dernières 24 heures.' }}
                            </span>

                        </div>
                    </div>
                </div>
                <div class="fr-mt-2v">
                    <p>Dernière synchronisation le {{ items.data_interconnexion.LastSyncAt }}</p>
                    <p class="fr-text--right"><a href="{{ path('back_interconnexion_index') }}">Voir l'historique</a></p>
                </div>
            </div>
        {% endif %}
    </div>
</section>

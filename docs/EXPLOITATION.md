# Document d'exploitation

## Introduction et Contexte

### Objectif du document
Ce document a pour objectif de permettre à l'équipe Histologe (ou tout repreneur) de prendre la partie technique de la plateforme en main.

### Contexte opérationnel
Histologe est un système d'information qui permet de détecter et accélérer la prise en charge du mal-logement.

Cette plateforme fournit 
- un guichet unique de signalement à des usagers en situation de mal-logement,
- un back-office pour permettre aux agents de communiquer plus facilement et résoudre plus rapidement les signalements qu'ils reçoivent.

Trois types de personnes y ont accès :
- les administrateurs techniques et métier du système
- les agents et responsables de territoire qui accèdent au back-office et gèrent les signalements
- les usagers qui déposent un signalement et peuvent ensuite suivre l'évolution de son traitement

## Procédures d'Exploitation

### Démarrage et arrêt des systèmes
Le système d'information est de type monolythique et hébergé par le prestataire Scalingo.
La mise en route et l'arrête des systèmes se fait grâce à l'interface de gestion fournie par Scalingo.

Trois conteneurs séparés existent et peuvent être arrêtés ou redémarrés indépendamment.
L'utilisation de Redis permet d'augmenter ou réduire le nombre de serveur qui tournent en parallèle, au besoin, en cas d'évolution de l'activité.

### Surveillance des systèmes

#### Outils
- Le tableau de bord fourni par Scalingo donne un accès à l'état des accès au serveur et à la base de données
- Updown.io nous alerte en cas de baisse de performance soudaine
- Sentry nous alerte en cas d'erreur d'exécution de code
- Des tableaux de bord internes créés via Metabase permettent de visualiser les cas d'échec d'interconnexion avec d'autres services

#### Métriques et seuils d'alerte
Le logiciel updown.io envoie des notifications automatiques, en fonction du temps de réponse et de la métrique qu'ils appellent [Apdex](https://updown.io/faq/what-is-apdex).

### Gestion des Alertes
Voir le document de [Procédure de gestion des incidents de sécurité](https://github.com/MTES-MCT/histologe/wiki/Gestion-des-incidents-de-s%C3%A9curit%C3%A9)

## Maintenance Courante

### Tâches de maintenance régulière.
Chaque jour :
- la personne en charge du support de la plateforme vérifie la présence d'erreurs nouvelles ou récurrentes sur Sentry (via les alertes e-mail ou le tableau de bord)

Chaque semaine :
- les tableaux de bord de suivi (Metabase, Scalingo, Dashlord) sont consultés régulièrement.
- la personne en charge du support fait aussi une sauvegarde des bases de données et des fichiers de la plateforme sur un disque dur externe déconnecté le reste du temps

Nous suivons les évolutions majeures des frameworks utilisés pour rester sur des versions éprouvées et maintenues.

Le registre des équipements et applicatifs peut se trouver sur le [cloud de l'équipe](https://docs.google.com/spreadsheets/d/1KzdbRt-o58UL4Qtdzn5akOc9XmykcoEks5yClO0zrJc/edit?gid=0#gid=0).

### Procédures de Mise à Jour et de Patch Management

#### Mise à jour interne
Si un correctif est mis en place, une branche Git est créée, suivie d'une Pull Request relue par au moins un développeur tiers.

Un tunnel d'intégration continue fait des vérifications de qualité de code (SonarCloud) et de tests automatisés. Il est exécuté à chaque commit sur une PR et à chaque fusion de branche. Le déploiement n'est fait qu'une fois ces vérifications validées.

Le déploiement sur le serveur de production n'est fait que lors de la fusion entre une branche de développement et la branche `main`.

#### Composants tiers
- GitHub, via Dependabot, crée automatiquement des PR quand un composant a des vulnérabilités connues.
- Les versions de PHP, MySQL et Symfony sont mises à jour de manière régulière, en fonction des sorties stables

## Gestion des Incidents
Voir le document de [Procédure de gestion des incidents de sécurité](https://github.com/MTES-MCT/histologe/wiki/Gestion-des-incidents-de-s%C3%A9curit%C3%A9)

## Sécurité Opérationnelle

### Gestion des Accès et Authentification
Les mots de passe comportent au moins 12 caractères, dont 1 minuscule, 1 majuscule, 1 signe spécial et 1 chiffre.

#### Comptes administrateurs
Un compte administrateur a accès à l'ensemble des fonctionnalités du site.

Chaque personne de l'équipe a son propre compte administrateur. L'authentification se fait en double facteur : mot de passe et code envoyé par e-mail.

En cas de départ, l'accès est annulé et le compte est conservé mais archivé.

#### Comptes agents
Un compte d'agent a accès au back-office de la plateforme.
Trois rôles existent donnant accès à un éventail différent de fonctionnalités : agent, administrateur partenaire, administrateur territoire.

En cas de compte non-utilisé pendant plus de 2 ans, le compte est anonymisé et archivé.

### Sauvegardes et Restaurations
Voir le document de [Procédure de gestion des incidents de sécurité](https://github.com/MTES-MCT/histologe/wiki/Gestion-des-incidents-de-s%C3%A9curit%C3%A9)

## Références

- [Site](https://histologe.beta.gouv.fr/)

### Documentation interne
- [Documentation](https://github.com/MTES-MCT/histologe/wiki/)
- [Documentation usager](https://documentation.histologe.beta.gouv.fr/)
- [Documentation technique](../README.md)
- [Dossier d'Architecture Technique (DAT)](./ARCHITECTURE.md)

### Services externes
- [Scalingo](https://dashboard.scalingo.com/)
- [Always Data](https://admin.alwaysdata.com/user/)
- [Dashlord](http://dashlord.mte.incubateur.net/url/histologe-beta-gouv-fr/)
- [Sentry incubateur](https://sentry.incubateur.net/)
- [Matomo](https://histologe.matomo.cloud/)
- [Metabase](https://histologe-metabase.osc-fr1.scalingo.io/)
- [Brevo](https://app.brevo.com/)
